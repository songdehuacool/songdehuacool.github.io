<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Golang深入学习6-使用pprof进行性能分析 - songdehua blog</title><meta name="author" content="">
<meta name="description" content="pprof 用来做 Go 程序的性能监控，让我们知道在什么地方耗费了多少 CPU、memory。
"><meta name="keywords" content='Golang'>
  <meta itemprop="name" content="Golang深入学习6-使用pprof进行性能分析">
  <meta itemprop="description" content="pprof 用来做 Go 程序的性能监控，让我们知道在什么地方耗费了多少 CPU、memory。">
  <meta itemprop="datePublished" content="2020-07-27T18:46:00+08:00">
  <meta itemprop="dateModified" content="2020-07-27T00:00:00+00:00">
  <meta itemprop="wordCount" content="2348">
  <meta itemprop="image" content="http://localhost:1313/logo.png">
  <meta itemprop="keywords" content="Golang"><meta property="og:url" content="http://localhost:1313/2020/golang-deep-learning-6-performance-analysis-pprof/">
  <meta property="og:site_name" content="songdehua blog">
  <meta property="og:title" content="Golang深入学习6-使用pprof进行性能分析">
  <meta property="og:description" content="pprof 用来做 Go 程序的性能监控，让我们知道在什么地方耗费了多少 CPU、memory。">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-07-27T18:46:00+08:00">
    <meta property="article:modified_time" content="2020-07-27T00:00:00+00:00">
    <meta property="article:tag" content="Golang">
    <meta property="og:image" content="http://localhost:1313/logo.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/logo.png">
  <meta name="twitter:title" content="Golang深入学习6-使用pprof进行性能分析">
  <meta name="twitter:description" content="pprof 用来做 Go 程序的性能监控，让我们知道在什么地方耗费了多少 CPU、memory。">
<meta name="application-name" content="songdehua&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="songdehua&#39;s Blog"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="http://localhost:1313/2020/golang-deep-learning-6-performance-analysis-pprof/" title="Golang深入学习6-使用pprof进行性能分析 - songdehua blog" /><link rel="prev" type="text/html" href="http://localhost:1313/2020/golang-deep-learning-5-debug-with-dlv/" title="Golang深入学习5-使用dlv调试程序" /><link rel="next" type="text/html" href="http://localhost:1313/2020/golang-deep-learning-7-scheduler-and-garbage-collection/" title="Golang深入学习7-调度器与垃圾回收" /><link rel="alternate" type="text/markdown" href="http://localhost:1313/2020/golang-deep-learning-6-performance-analysis-pprof/index.md" title="Golang深入学习6-使用pprof进行性能分析 - songdehua blog"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Golang深入学习6-使用pprof进行性能分析",
    "inLanguage": "en",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/localhost:1313\/2020\/golang-deep-learning-6-performance-analysis-pprof\/"
    },"genre": "posts","keywords": "Golang","wordcount":  2348 ,
    "url": "http:\/\/localhost:1313\/2020\/golang-deep-learning-6-performance-analysis-pprof\/","datePublished": "2020-07-27T18:46:00+08:00","dateModified": "2020-07-27T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Author"
      },"description": ""
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper" data-github-corner="right">
    <div class="header-title">
      <a href="/" title="songdehua blog"><img loading="lazy" src="https://picped-1301226557.cos.ap-beijing.myqcloud.com/avatar.png" alt="songdehua blog" data-title="songdehua blog" width="26" height="26" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">songdehua&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/collection/"
                
                
              ><i class="fa-solid fa-bookmark fa-fw fa-sm" aria-hidden="true"></i> 集子</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="Search titles or contents ..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="songdehua blog"><img loading="lazy" src="https://picped-1301226557.cos.ap-beijing.myqcloud.com/avatar.png" alt="songdehua blog" data-title="songdehua blog" width="26" height="26" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">songdehua&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="Search titles or contents ..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              Cancel
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/collection/"
                  
                  
                ><i class="fa-solid fa-bookmark fa-fw fa-sm" aria-hidden="true"></i> 集子</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Golang深入学习6-使用pprof进行性能分析</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span><span class="post-included-in">&nbsp;included in <a href="/categories/%E7%88%B1%E7%BC%96%E7%A8%8B%E7%88%B1%E6%8A%80%E6%9C%AF%E7%9A%84%E5%AD%A9%E5%AD%90/" class="post-category" title="Category - 爱编程爱技术的孩子"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 爱编程爱技术的孩子</a></span></div><div class="post-meta-line"><span title="published on 2020-07-27 18:46:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2020-07-27">2020-07-27</time></span>&nbsp;<span title="Updated on 2020-07-27 00:00:00"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden="true"></i><time datetime="2020-07-27">2020-07-27</time></span>&nbsp;<span title="2348 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 2400 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>12 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-引入">1. 引入</a></li>
    <li><a href="#2-分析普通程序">2. 分析普通程序</a></li>
    <li><a href="#2-时间与存储优化">2. 时间与存储优化</a></li>
    <li><a href="#3-分析网络程序">3. 分析网络程序</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><div class="details admonition warning open">
      <div class="details-summary admonition-title">
        <i class="icon fa-solid fa-exclamation-triangle fa-fw" aria-hidden="true"></i>Warning<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
      </div>
      <div class="details-content">
        <div class="admonition-content">This article was last updated on 2020-07-27, the content may be out of date.</div>
      </div>
    </div><p>pprof 用来做 Go 程序的性能监控，让我们知道在什么地方耗费了多少 CPU、memory。</p>
<p>pprof 关注的方面有：</p>
<ul>
<li>CPU profile：报告程序的 CPU 使用情况，按照一定频率去采集应用程序在 CPU 和寄存器上面的数据</li>
<li>Memory Profile（Heap Profile）：报告程序的内存使用情况</li>
<li>Block Profiling：报告 goroutines 不在运行状态的情况，可以用来分析和查找死锁等性能瓶颈</li>
<li>Goroutine Profiling：报告 goroutines 的使用情况，有哪些 goroutine，它们的调用关系是怎样的</li>
</ul>
<h2 id="1-引入" class="heading-element"><span>1. 引入</span>
  <a href="#1-%e5%bc%95%e5%85%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>pprof 可以从以下两个包中引入：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;net/http/pprof&#34;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;runtime/pprof&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>其中 net/http/pprof 底层使用 runtime/pprof 包，只是进行了一下封装，并在 http 端口上暴露出来。</p>
<p>如果我们的服务是一直运行的，如 web 应用，通过简单的导入  <code>import _ &quot;net/http/pprof&quot;</code>，就可以在运行 web 应用后在浏览器 http://localhost:port/debug/pprof 直接看到当前 web 服务的状态，包括 CPU 占用情况和内存使用情况等。</p>
<p>如果我们的程序不是 web 应用，而是一个服务进程，那么可以导入 <code>net/http/pprof</code> 包，然后主动开启一个 Goroutine 在端口进行监听</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;localhost:6060&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}()</span></span></span></code></pre></td></tr></table>
</div>
</div><p>如果我们的程序只是简单的 Go 程序，那么只能使用 <code>runtime/pprof</code> 包，具体做法是在代码中加入下面这段程序，然后在运行时（go run 或 go build等命令）加入 &ndash;cpuprofile 参数，比如 <code>go run demo.go --cpuprofile=demo.prof</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">cpuprofile</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;cpuprofile&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;write cpu profile to file&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">*</span><span class="nx">cpuprofile</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">f</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="o">*</span><span class="nx">cpuprofile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pprof</span><span class="p">.</span><span class="nf">StartCPUProfile</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">defer</span> <span class="nx">pprof</span><span class="p">.</span><span class="nf">StopCPUProfile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span></span></span></code></pre></td></tr></table>
</div>
</div><p>命令执行完后当前目录会生成 demo.prof 文件，其中记录了 CPU 运行的信息，下一步就可以利用该文件查看相关的信息，使用 go tool pprof 命令来执行，如果要进行可视化，需要安装 <a href="http://www.graphviz.org/"target="_blank" rel="external nofollow noopener noreferrer">graphviz</a></p>
<p>win10 下可以使用 chocolatye 或 winget 安装，如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">&gt;</span> <span class="n">choco</span> <span class="n">install</span> <span class="n">graphviz</span>
</span></span><span class="line"><span class="cl"><span class="c"># 或</span>
</span></span><span class="line"><span class="cl"><span class="p">&gt;</span> <span class="n">winget</span> <span class="n">install</span> <span class="n">graphviz</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="2-分析普通程序" class="heading-element"><span>2. 分析普通程序</span>
  <a href="#2-%e5%88%86%e6%9e%90%e6%99%ae%e9%80%9a%e7%a8%8b%e5%ba%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>主要参考的文章是 Go Post 中的 <a href="https://blog.go-zh.org/profiling-go-programs"target="_blank" rel="external nofollow noopener noreferrer">Profiling Go Programs</a></p>
<p>测试代码来自于 <a href="https://github.com/rsc/benchgraffiti/tree/master/havlak"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/rsc/benchgraffiti/tree/master/havlak</a></p>
<p>我们使用 go mod 建立了一个测试项目文件夹，第一次使用测试代码中的 havlak1.go 文件，将该文件复制到测试项目根目录。由于其中已经引入了 <code>runtime/pprof</code> 包并包含了如下代码，我们不需要做修改，执行执行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">cpuprofile</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;cpuprofile&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;write cpu profile to file&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">*</span><span class="nx">cpuprofile</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">f</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="o">*</span><span class="nx">cpuprofile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pprof</span><span class="p">.</span><span class="nf">StartCPUProfile</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">defer</span> <span class="nx">pprof</span><span class="p">.</span><span class="nf">StopCPUProfile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span></span></span></code></pre></td></tr></table>
</div>
</div><p>执行时加入 &ndash;cpuprofile=havlak1.prof 参数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ go build havlak1.go
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ./havlak1 --cpuprofile<span class="o">=</span>havlak1.prof
</span></span><span class="line"><span class="cl"><span class="c1"># of loops: 76000 (including 1 artificial root node)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ls
</span></span><span class="line"><span class="cl">go.mod  havlak1.exe  havlak1.go  havlak1.prof</span></span></code></pre></td></tr></table>
</div>
</div><p>然后运行 <code>go tool pprof</code> 命令与 profile 交互</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ go tool pprof havlak1.exe havlak1.prof
</span></span><span class="line"><span class="cl">File: havlak1.exe
</span></span><span class="line"><span class="cl">Type: cpu
</span></span><span class="line"><span class="cl">Time: Jul 25, <span class="m">2020</span> at 7:23pm <span class="o">(</span>CST<span class="o">)</span>
</span></span><span class="line"><span class="cl">Duration: 21.52s, Total <span class="nv">samples</span> <span class="o">=</span> 34.77s <span class="o">(</span>161.56%<span class="o">)</span>
</span></span><span class="line"><span class="cl">Entering interactive mode <span class="o">(</span><span class="nb">type</span> <span class="s2">&#34;help&#34;</span> <span class="k">for</span> commands, <span class="s2">&#34;o&#34;</span> <span class="k">for</span> options<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>pprof<span class="o">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>最主要的命令是 <code>topN</code> ，用来输出最耗 CPU 的前N个调用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="p">(</span><span class="nx">pprof</span><span class="p">)</span> <span class="nx">top10</span>
</span></span><span class="line"><span class="cl"><span class="nx">Showing</span> <span class="nx">nodes</span> <span class="nx">accounting</span> <span class="k">for</span> <span class="mi">21340</span><span class="nx">ms</span><span class="p">,</span> <span class="mf">61.37</span><span class="o">%</span> <span class="nx">of</span> <span class="mi">34770</span><span class="nx">ms</span> <span class="nx">total</span>
</span></span><span class="line"><span class="cl"><span class="nx">Dropped</span> <span class="mi">168</span> <span class="nf">nodes</span> <span class="p">(</span><span class="nx">cum</span> <span class="o">&lt;=</span> <span class="mf">173.85</span><span class="nx">ms</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">Showing</span> <span class="nx">top</span> <span class="mi">10</span> <span class="nx">nodes</span> <span class="nx">out</span> <span class="nx">of</span> <span class="mi">89</span>
</span></span><span class="line"><span class="cl">      <span class="nx">flat</span>  <span class="nx">flat</span><span class="o">%</span>   <span class="nx">sum</span><span class="o">%</span>        <span class="nx">cum</span>   <span class="nx">cum</span><span class="o">%</span>
</span></span><span class="line"><span class="cl">    <span class="mi">5340</span><span class="nx">ms</span> <span class="mf">15.36</span><span class="o">%</span> <span class="mf">15.36</span><span class="o">%</span>    <span class="mi">12320</span><span class="nx">ms</span> <span class="mf">35.43</span><span class="o">%</span>  <span class="nx">runtime</span><span class="p">.</span><span class="nx">scanobject</span>
</span></span><span class="line"><span class="cl">    <span class="mi">3190</span><span class="nx">ms</span>  <span class="mf">9.17</span><span class="o">%</span> <span class="mf">24.53</span><span class="o">%</span>     <span class="mi">3650</span><span class="nx">ms</span> <span class="mf">10.50</span><span class="o">%</span>  <span class="nx">runtime</span><span class="p">.</span><span class="nx">mapaccess1_fast64</span>
</span></span><span class="line"><span class="cl">    <span class="mi">2650</span><span class="nx">ms</span>  <span class="mf">7.62</span><span class="o">%</span> <span class="mf">32.15</span><span class="o">%</span>    <span class="mi">16670</span><span class="nx">ms</span> <span class="mf">47.94</span><span class="o">%</span>  <span class="nx">main</span><span class="p">.</span><span class="nx">FindLoops</span>
</span></span><span class="line"><span class="cl">    <span class="mi">2240</span><span class="nx">ms</span>  <span class="mf">6.44</span><span class="o">%</span> <span class="mf">38.60</span><span class="o">%</span>     <span class="mi">3320</span><span class="nx">ms</span>  <span class="mf">9.55</span><span class="o">%</span>  <span class="nx">runtime</span><span class="p">.</span><span class="nx">findObject</span>
</span></span><span class="line"><span class="cl">    <span class="mi">1800</span><span class="nx">ms</span>  <span class="mf">5.18</span><span class="o">%</span> <span class="mf">43.77</span><span class="o">%</span>     <span class="mi">2920</span><span class="nx">ms</span>  <span class="mf">8.40</span><span class="o">%</span>  <span class="nx">runtime</span><span class="p">.</span><span class="nx">greyobject</span>
</span></span><span class="line"><span class="cl">    <span class="mi">1490</span><span class="nx">ms</span>  <span class="mf">4.29</span><span class="o">%</span> <span class="mf">48.06</span><span class="o">%</span>     <span class="mi">6540</span><span class="nx">ms</span> <span class="mf">18.81</span><span class="o">%</span>  <span class="nx">runtime</span><span class="p">.</span><span class="nx">mallocgc</span>
</span></span><span class="line"><span class="cl">    <span class="mi">1480</span><span class="nx">ms</span>  <span class="mf">4.26</span><span class="o">%</span> <span class="mf">52.32</span><span class="o">%</span>     <span class="mi">4230</span><span class="nx">ms</span> <span class="mf">12.17</span><span class="o">%</span>  <span class="nx">main</span><span class="p">.</span><span class="nx">DFS</span>
</span></span><span class="line"><span class="cl">    <span class="mi">1230</span><span class="nx">ms</span>  <span class="mf">3.54</span><span class="o">%</span> <span class="mf">55.85</span><span class="o">%</span>     <span class="mi">3510</span><span class="nx">ms</span> <span class="mf">10.09</span><span class="o">%</span>  <span class="nx">runtime</span><span class="p">.</span><span class="nx">mapassign_fast64ptr</span>
</span></span><span class="line"><span class="cl">    <span class="mi">1000</span><span class="nx">ms</span>  <span class="mf">2.88</span><span class="o">%</span> <span class="mf">58.73</span><span class="o">%</span>     <span class="mi">1450</span><span class="nx">ms</span>  <span class="mf">4.17</span><span class="o">%</span>  <span class="nx">runtime</span><span class="p">.</span><span class="nx">heapBitsSetType</span>
</span></span><span class="line"><span class="cl">     <span class="mi">920</span><span class="nx">ms</span>  <span class="mf">2.65</span><span class="o">%</span> <span class="mf">61.37</span><span class="o">%</span>     <span class="mi">1050</span><span class="nx">ms</span>  <span class="mf">3.02</span><span class="o">%</span>  <span class="nx">runtime</span><span class="p">.</span><span class="nf">spanOf</span> <span class="p">(</span><span class="nx">inline</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nx">pprof</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>flat、flat% 表示函数在 CPU上运行的时间及百分比</li>
<li>sum% 表示列表中自己包括前面的函数CPU使用比例的累积，比如第三行 main.FindLoops 显示的 32.15% 其实就等于前面三个调用的比例之和 15.36% + 9.17% + 7.62% = 32.15%</li>
<li>cum、cum% 表示该函数及其子函数运行所占的时间总和及比例总和，应该大于等于自己执行所占的时间和比例，也就是最前面两列</li>
</ul>
<p>添加 -cum 参数可以按照 cum 来排序</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="p">(</span><span class="nx">pprof</span><span class="p">)</span> <span class="nx">top5</span> <span class="o">-</span><span class="nx">cum</span>
</span></span><span class="line"><span class="cl"><span class="nx">Showing</span> <span class="nx">nodes</span> <span class="nx">accounting</span> <span class="k">for</span> <span class="mf">2.67</span><span class="nx">s</span><span class="p">,</span> <span class="mf">7.68</span><span class="o">%</span> <span class="nx">of</span> <span class="mf">34.77</span><span class="nx">s</span> <span class="nx">total</span>
</span></span><span class="line"><span class="cl"><span class="nx">Dropped</span> <span class="mi">168</span> <span class="nf">nodes</span> <span class="p">(</span><span class="nx">cum</span> <span class="o">&lt;=</span> <span class="mf">0.17</span><span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">Showing</span> <span class="nx">top</span> <span class="mi">5</span> <span class="nx">nodes</span> <span class="nx">out</span> <span class="nx">of</span> <span class="mi">89</span>
</span></span><span class="line"><span class="cl">      <span class="nx">flat</span>  <span class="nx">flat</span><span class="o">%</span>   <span class="nx">sum</span><span class="o">%</span>        <span class="nx">cum</span>   <span class="nx">cum</span><span class="o">%</span>
</span></span><span class="line"><span class="cl">         <span class="mi">0</span>     <span class="mi">0</span><span class="o">%</span>     <span class="mi">0</span><span class="o">%</span>     <span class="mf">16.79</span><span class="nx">s</span> <span class="mf">48.29</span><span class="o">%</span>  <span class="nx">main</span><span class="p">.</span><span class="nx">main</span>
</span></span><span class="line"><span class="cl">         <span class="mi">0</span>     <span class="mi">0</span><span class="o">%</span>     <span class="mi">0</span><span class="o">%</span>     <span class="mf">16.79</span><span class="nx">s</span> <span class="mf">48.29</span><span class="o">%</span>  <span class="nx">runtime</span><span class="p">.</span><span class="nx">main</span>
</span></span><span class="line"><span class="cl">         <span class="mi">0</span>     <span class="mi">0</span><span class="o">%</span>     <span class="mi">0</span><span class="o">%</span>     <span class="mf">16.67</span><span class="nx">s</span> <span class="mf">47.94</span><span class="o">%</span>  <span class="nx">main</span><span class="p">.</span><span class="nf">FindHavlakLoops</span> <span class="p">(</span><span class="nx">inline</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="mf">2.65</span><span class="nx">s</span>  <span class="mf">7.62</span><span class="o">%</span>  <span class="mf">7.62</span><span class="o">%</span>     <span class="mf">16.67</span><span class="nx">s</span> <span class="mf">47.94</span><span class="o">%</span>  <span class="nx">main</span><span class="p">.</span><span class="nx">FindLoops</span>
</span></span><span class="line"><span class="cl">     <span class="mf">0.02</span><span class="nx">s</span> <span class="mf">0.058</span><span class="o">%</span>  <span class="mf">7.68</span><span class="o">%</span>     <span class="mf">15.16</span><span class="nx">s</span> <span class="mf">43.60</span><span class="o">%</span>  <span class="nx">runtime</span><span class="p">.</span><span class="nf">systemstack</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nx">pprof</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>实际上 main.FindLoops 和 main.main 的总和应当为 100%，但是 pprof 不会统计所有的调用，递归调用层次过深的一些执行会被忽略。</p>
<p>另外，使用 <code>web</code> 命令可以生成调用关系图，是一个 svg 文件，可视化的方式可以帮助我们更好的理解，该命令需要 graphviz 工具的支持，这也是为什么前面要安装它</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>pprof<span class="o">)</span> web</span></span></code></pre></td></tr></table>
</div>
</div><p>执行该命令后图片会自动打开</p>
<p><img loading="lazy" src="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof002.png" alt="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof002.png" srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof002.png?size=small, https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof002.png?size=medium 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof002.png?size=large 2x" data-title="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof002.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>图片中每个方框都代表一个函数，方框的大小根据 CPU 占用比例确定，箭头表示调用关系，从上到下调用层次逐渐加深，表示调用的线条上出现的数字表示调用次数，递归调用自身会有一个自己指向自己的箭头。</p>
<p>从图中看到 mapaccess 占用比例较大，我们可以只显示与它相关的调用，从而使图片逻辑更清晰。可以看到 mapaccess1 主要由 main.FindLoops 和 main.DFS 调用。</p>
<p><img loading="lazy" src="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof003.png" alt="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof003.png" srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof003.png?size=small, https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof003.png?size=medium 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof003.png?size=large 2x" data-title="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof003.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>我们还可以通过指定函数进入某个函数的细节，DFS逻辑比较简单，以它为例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>pprof<span class="o">)</span> web DFS</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof004.png" alt="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof004.png" srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof004.png?size=small, https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof004.png?size=medium 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof004.png?size=large 2x" data-title="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof004.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>也可以使用命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>pprof<span class="o">)</span> list DFS
</span></span><span class="line"><span class="cl">Total: 34.77s
</span></span><span class="line"><span class="cl"><span class="nv">ROUTINE</span> <span class="o">========================</span> main.DFS in F:<span class="se">\G</span>o-web<span class="se">\h</span>avlak1.go
</span></span><span class="line"><span class="cl">     1.48s      8.38s <span class="o">(</span>flat, cum<span class="o">)</span> 24.10% of Total
</span></span><span class="line"><span class="cl">         .          .    233:   <span class="k">return</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">         .          .    234:<span class="o">}</span>
</span></span><span class="line"><span class="cl">         .          .    235:
</span></span><span class="line"><span class="cl">         .          .    236:// DFS - Depth-First-Search and node numbering.
</span></span><span class="line"><span class="cl">         .          .    237://
</span></span><span class="line"><span class="cl">      30ms       30ms    238:func DFS<span class="o">(</span>currentNode *BasicBlock, nodes <span class="o">[]</span>*UnionFindNode, number map<span class="o">[</span>*BasicBlock<span class="o">]</span>int, last <span class="o">[]</span>int, current int<span class="o">)</span> int <span class="o">{</span>
</span></span><span class="line"><span class="cl">      20ms      240ms    239:   nodes<span class="o">[</span>current<span class="o">]</span>.Init<span class="o">(</span>currentNode, current<span class="o">)</span>
</span></span><span class="line"><span class="cl">      20ms      340ms    240:   number<span class="o">[</span>currentNode<span class="o">]</span> <span class="o">=</span> current
</span></span><span class="line"><span class="cl">         .          .    241:
</span></span><span class="line"><span class="cl">         .          .    242:   lastid :<span class="o">=</span> current
</span></span><span class="line"><span class="cl">     1.02s      1.02s    243:   <span class="k">for</span> _, target :<span class="o">=</span> range currentNode.OutEdges <span class="o">{</span>
</span></span><span class="line"><span class="cl">     190ms      1.73s    244:           <span class="k">if</span> number<span class="o">[</span>target<span class="o">]</span> <span class="o">==</span> unvisited <span class="o">{</span>
</span></span><span class="line"><span class="cl">      80ms      4.23s    245:                   <span class="nv">lastid</span> <span class="o">=</span> DFS<span class="o">(</span>target, nodes, number, last, lastid+1<span class="o">)</span>
</span></span><span class="line"><span class="cl">         .          .    246:           <span class="o">}</span>
</span></span><span class="line"><span class="cl">         .          .    247:   <span class="o">}</span>
</span></span><span class="line"><span class="cl">      80ms      750ms    248:   last<span class="o">[</span>number<span class="o">[</span>currentNode<span class="o">]]</span> <span class="o">=</span> lastid
</span></span><span class="line"><span class="cl">      40ms       40ms    249:   <span class="k">return</span> lastid
</span></span><span class="line"><span class="cl">         .          .    250:<span class="o">}</span>
</span></span><span class="line"><span class="cl">         .          .    251:
</span></span><span class="line"><span class="cl">         .          .    252:// FindLoops
</span></span><span class="line"><span class="cl">         .          .    253://
</span></span><span class="line"><span class="cl">         .          .    254:// Find loops and build loop forest using Havlak<span class="err">&#39;</span>s algorithm, which
</span></span><span class="line"><span class="cl"><span class="o">(</span>pprof<span class="o">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>前两列分别是 flat 和 cum，也就是该行执行占用的时间和该行及该行调用的函数执行占用的总时间，第三列是源码行数。所以我们看到第 245 行由于出现了 DFS 这个递归函数，总占用时间为 4.23s，是最多的。除了该行之外，占用最多的就是第239、240、248三行，主要原因是映射的使用占用了大量时间，所以我们在使用中应尽可能使用数组和切片，而减少使用映射。</p>
<h2 id="2-时间与存储优化" class="heading-element"><span>2. 时间与存储优化</span>
  <a href="#2-%e6%97%b6%e9%97%b4%e4%b8%8e%e5%ad%98%e5%82%a8%e4%bc%98%e5%8c%96" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>将 DFS 函数参数中的 number 由映射更改为切片，可以将运行时间减少两倍，我们使用测试文件列表中的 havlak2.go，执行同样的测试过程可以验证这一点，原先的 DFS cum 是 4230ms，现在已经只有 830ms。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ go build havlak2.go
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ./havlak2 --cpuprofile<span class="o">=</span>havlak2.prof
</span></span><span class="line"><span class="cl"><span class="c1"># of loops: 76000 (including 1 artificial root node)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ go tool pprof havlak2.exe havlak2.prof
</span></span><span class="line"><span class="cl">File: havlak2.exe
</span></span><span class="line"><span class="cl">Type: cpu
</span></span><span class="line"><span class="cl">Time: Jul 25, <span class="m">2020</span> at 8:51pm <span class="o">(</span>CST<span class="o">)</span>
</span></span><span class="line"><span class="cl">Duration: 12.36s, Total <span class="nv">samples</span> <span class="o">=</span> 22.91s <span class="o">(</span>185.34%<span class="o">)</span>
</span></span><span class="line"><span class="cl">Entering interactive mode <span class="o">(</span><span class="nb">type</span> <span class="s2">&#34;help&#34;</span> <span class="k">for</span> commands, <span class="s2">&#34;o&#34;</span> <span class="k">for</span> options<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>pprof<span class="o">)</span> top10
</span></span><span class="line"><span class="cl">Showing nodes accounting <span class="k">for</span> 14360ms, 62.68% of 22910ms total
</span></span><span class="line"><span class="cl">Dropped <span class="m">132</span> nodes <span class="o">(</span>cum &lt;<span class="o">=</span> 114.55ms<span class="o">)</span>
</span></span><span class="line"><span class="cl">Showing top <span class="m">10</span> nodes out of <span class="m">85</span>
</span></span><span class="line"><span class="cl">      flat  flat%   sum%        cum   cum%
</span></span><span class="line"><span class="cl">    4130ms 18.03% 18.03%     9810ms 42.82%  runtime.scanobject
</span></span><span class="line"><span class="cl">    1850ms  8.08% 26.10%     2570ms 11.22%  runtime.findObject
</span></span><span class="line"><span class="cl">    1800ms  7.86% 33.96%    11070ms 48.32%  main.FindLoops
</span></span><span class="line"><span class="cl">    1530ms  6.68% 40.64%     2510ms 10.96%  runtime.greyobject
</span></span><span class="line"><span class="cl">    1450ms  6.33% 46.97%     5940ms 25.93%  runtime.mallocgc
</span></span><span class="line"><span class="cl">     950ms  4.15% 51.11%     1290ms  5.63%  runtime.heapBitsSetType
</span></span><span class="line"><span class="cl">     680ms  2.97% 54.08%      830ms  3.62%  main.DFS
</span></span><span class="line"><span class="cl">     670ms  2.92% 57.01%      670ms  2.92%  runtime.memclrNoHeapPointers
</span></span><span class="line"><span class="cl">     670ms  2.92% 59.93%      670ms  2.92%  runtime.nextFreeFast
</span></span><span class="line"><span class="cl">     630ms  2.75% 62.68%      630ms  2.75%  runtime.arenaIndex <span class="o">(</span>partial-inline<span class="o">)</span> </span></span></code></pre></td></tr></table>
</div>
</div><p>附： <a href="https://github.com/rsc/benchgraffiti/commit/58ac27bcac3ffb553c29d0b3fb64745c91c95948"target="_blank" rel="external nofollow noopener noreferrer">diff between havlak1 and havlak2</a></p>
<p>现在，DFS 不再是时间瓶颈，取而代之的是内存分配与垃圾回收，上面的结果中 runtime.mallocgc 占了一大部分。为了找出为什么垃圾回收时间占用这么多，我们来分析内存占用，这时候使用 memprofile ，不再是 cpuprofile。首先在主函数中替换如下部分</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">memprofile</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;memprofile&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;write memory profile to this file&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">FindHavlakLoops</span><span class="p">(</span><span class="nx">cfgraph</span><span class="p">,</span> <span class="nx">lsgraph</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">*</span><span class="nx">memprofile</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">f</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="o">*</span><span class="nx">memprofile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pprof</span><span class="p">.</span><span class="nf">WriteHeapProfile</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">f</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>然后使用 &ndash;memprofile 标志编译源码，此时使用测试文件列表中的 havlak3</p>
<p>附：<a href="https://github.com/rsc/benchgraffiti/commit/b78dac106bea1eb3be6bb3ca5dba57c130268232"target="_blank" rel="external nofollow noopener noreferrer">diff from havlak2</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ go build havlak3.go
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ./havlak3 --memprofile<span class="o">=</span>havlak3.mprof
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ go tool pprof havlak3.exe havlak3.mprof
</span></span><span class="line"><span class="cl">$ go tool pprof havlak3.exe havlak3.mprof
</span></span><span class="line"><span class="cl">File: havlak3.exe
</span></span><span class="line"><span class="cl">Type: inuse_space
</span></span><span class="line"><span class="cl">Time: Jul 25, <span class="m">2020</span> at 9:07pm <span class="o">(</span>CST<span class="o">)</span>
</span></span><span class="line"><span class="cl">Entering interactive mode <span class="o">(</span><span class="nb">type</span> <span class="s2">&#34;help&#34;</span> <span class="k">for</span> commands, <span class="s2">&#34;o&#34;</span> <span class="k">for</span> options<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>pprof<span class="o">)</span> top5
</span></span><span class="line"><span class="cl">Showing nodes accounting <span class="k">for</span> 53.39MB, 100% of 53.39MB total
</span></span><span class="line"><span class="cl">Showing top <span class="m">5</span> nodes out of <span class="m">13</span>
</span></span><span class="line"><span class="cl">      flat  flat%   sum%        cum   cum%
</span></span><span class="line"><span class="cl">   33.10MB 62.00% 62.00%    33.10MB 62.00%  main.FindLoops
</span></span><span class="line"><span class="cl">   11.50MB 21.54% 83.54%    11.50MB 21.54%  main.NewBasicBlock <span class="o">(</span>inline<span class="o">)</span>
</span></span><span class="line"><span class="cl">    4.50MB  8.43% 91.96%     4.50MB  8.43%  main.<span class="o">(</span>*BasicBlock<span class="o">)</span>.AddInEdge
</span></span><span class="line"><span class="cl">    2.29MB  4.29% 96.25%    13.79MB 25.83%  main.<span class="o">(</span>*CFG<span class="o">)</span>.CreateNode
</span></span><span class="line"><span class="cl">       2MB  3.75%   100%        2MB  3.75%  main.<span class="o">(</span>*BasicBlock<span class="o">)</span>.AddOutEdge
</span></span><span class="line"><span class="cl"><span class="o">(</span>pprof<span class="o">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>flat 和 cum 已经从时间占用变成了存储占用，可以看到 main.FindLoops 占用最多，达到了 62.00%，使用 <code>list</code> 命令查看具体情况</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>pprof<span class="o">)</span> list FindLoops
</span></span><span class="line"><span class="cl">Total: 53.39MB
</span></span><span class="line"><span class="cl"><span class="nv">ROUTINE</span> <span class="o">========================</span> main.FindLoops in F:<span class="se">\G</span>o-web<span class="se">\h</span>avlak3.go
</span></span><span class="line"><span class="cl">   33.10MB    33.10MB <span class="o">(</span>flat, cum<span class="o">)</span> 62.00% of Total
</span></span><span class="line"><span class="cl">         .          .    261:           <span class="k">return</span>
</span></span><span class="line"><span class="cl">         .          .    262:   <span class="o">}</span>
</span></span><span class="line"><span class="cl">         .          .    263:
</span></span><span class="line"><span class="cl">         .          .    264:   size :<span class="o">=</span> cfgraph.NumNodes<span class="o">()</span>
</span></span><span class="line"><span class="cl">         .          .    265:
</span></span><span class="line"><span class="cl">    1.97MB     1.97MB    266:   nonBackPreds :<span class="o">=</span> make<span class="o">([]</span>map<span class="o">[</span>int<span class="o">]</span>bool, size<span class="o">)</span>
</span></span><span class="line"><span class="cl">    5.77MB     5.77MB    267:   backPreds :<span class="o">=</span> make<span class="o">([][]</span>int, size<span class="o">)</span>
</span></span><span class="line"><span class="cl">         .          .    268:
</span></span><span class="line"><span class="cl">    1.97MB     1.97MB    269:   number :<span class="o">=</span> make<span class="o">([]</span>int, size<span class="o">)</span>
</span></span><span class="line"><span class="cl">    1.97MB     1.97MB    270:   header :<span class="o">=</span> make<span class="o">([]</span>int, size, size<span class="o">)</span>
</span></span><span class="line"><span class="cl">    1.97MB     1.97MB    271:   types :<span class="o">=</span> make<span class="o">([]</span>int, size, size<span class="o">)</span>
</span></span><span class="line"><span class="cl">    1.97MB     1.97MB    272:   last :<span class="o">=</span> make<span class="o">([]</span>int, size, size<span class="o">)</span>
</span></span><span class="line"><span class="cl">    1.97MB     1.97MB    273:   nodes :<span class="o">=</span> make<span class="o">([]</span>*UnionFindNode, size, size<span class="o">)</span>        
</span></span><span class="line"><span class="cl">         .          .    274:
</span></span><span class="line"><span class="cl">         .          .    275:   <span class="k">for</span> i :<span class="o">=</span> 0<span class="p">;</span> i &lt; size<span class="p">;</span> i++ <span class="o">{</span>
</span></span><span class="line"><span class="cl">      11MB       11MB    276:           nodes<span class="o">[</span>i<span class="o">]</span> <span class="o">=</span> new<span class="o">(</span>UnionFindNode<span class="o">)</span>
</span></span><span class="line"><span class="cl">         .          .    277:   <span class="o">}</span>
</span></span><span class="line"><span class="cl">         .          .    278:
</span></span><span class="line"><span class="cl">         .          .    279:   // Step a:
</span></span><span class="line"><span class="cl">         .          .    280:   //   - initialize all nodes as unvisited.
</span></span><span class="line"><span class="cl">         .          .    281:   //   - depth-first traversal and numbering.        
</span></span><span class="line"><span class="cl">         .          .    282:   //   - unreached BB<span class="err">&#39;</span>s are marked as dead.
</span></span><span class="line"><span class="cl">         .          .    283:   //
</span></span><span class="line"><span class="cl">         .          .    284:   <span class="k">for</span> i, bb :<span class="o">=</span> range cfgraph.Blocks <span class="o">{</span>
</span></span><span class="line"><span class="cl">         .          .    285:           number<span class="o">[</span>bb.Name<span class="o">]</span> <span class="o">=</span> unvisited
</span></span><span class="line"><span class="cl">    4.50MB     4.50MB    286:           nonBackPreds<span class="o">[</span>i<span class="o">]</span> <span class="o">=</span> make<span class="o">(</span>map<span class="o">[</span>int<span class="o">]</span>bool<span class="o">)</span>       
</span></span><span class="line"><span class="cl">         .          .    287:   <span class="o">}</span>
</span></span><span class="line"><span class="cl">         .          .    288:
</span></span><span class="line"><span class="cl">         .          .    289:   DFS<span class="o">(</span>cfgraph.Start, nodes, number, last, 0<span class="o">)</span>
</span></span><span class="line"><span class="cl">         .          .    290:
</span></span><span class="line"><span class="cl">         .          .    291:   // Step b:
</span></span><span class="line"><span class="cl"><span class="o">(</span>pprof<span class="o">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>瓶颈依然在于 UnionFindNode 结构体的初始化和映射。</p>
<p>另外，如果我们执行 <code>go tool pprof</code> 加入 <code>--inuse_objects</code> ，看到的不是内存使用而是调用计数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ go tool pprof --inuse_objects havlak3.exe havlak3.mprof
</span></span><span class="line"><span class="cl">File: havlak3.exe
</span></span><span class="line"><span class="cl">Type: inuse_objects
</span></span><span class="line"><span class="cl">Time: Jul 25, <span class="m">2020</span> at 9:07pm <span class="o">(</span>CST<span class="o">)</span>
</span></span><span class="line"><span class="cl">Entering interactive mode <span class="o">(</span><span class="nb">type</span> <span class="s2">&#34;help&#34;</span> <span class="k">for</span> commands, <span class="s2">&#34;o&#34;</span> <span class="k">for</span> options<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>pprof<span class="o">)</span> list FindLoops
</span></span><span class="line"><span class="cl">Total: <span class="m">1171490</span>
</span></span><span class="line"><span class="cl"><span class="nv">ROUTINE</span> <span class="o">========================</span> main.FindLoops in F:<span class="se">\G</span>o-web<span class="se">\h</span>avlak3.go
</span></span><span class="line"><span class="cl">    <span class="m">458774</span>     <span class="m">458774</span> <span class="o">(</span>flat, cum<span class="o">)</span> 39.16% of Total
</span></span><span class="line"><span class="cl">         .          .    261:           <span class="k">return</span>
</span></span><span class="line"><span class="cl">         .          .    262:   <span class="o">}</span>
</span></span><span class="line"><span class="cl">         .          .    263:
</span></span><span class="line"><span class="cl">         .          .    264:   size :<span class="o">=</span> cfgraph.NumNodes<span class="o">()</span>
</span></span><span class="line"><span class="cl">         .          .    265:
</span></span><span class="line"><span class="cl">         <span class="m">1</span>          <span class="m">1</span>    266:   nonBackPreds :<span class="o">=</span> make<span class="o">([]</span>map<span class="o">[</span>int<span class="o">]</span>bool, size<span class="o">)</span>
</span></span><span class="line"><span class="cl">         <span class="m">1</span>          <span class="m">1</span>    267:   backPreds :<span class="o">=</span> make<span class="o">([][]</span>int, size<span class="o">)</span>
</span></span><span class="line"><span class="cl">         .          .    268:
</span></span><span class="line"><span class="cl">         <span class="m">1</span>          <span class="m">1</span>    269:   number :<span class="o">=</span> make<span class="o">([]</span>int, size<span class="o">)</span>
</span></span><span class="line"><span class="cl">         <span class="m">1</span>          <span class="m">1</span>    270:   header :<span class="o">=</span> make<span class="o">([]</span>int, size, size<span class="o">)</span>
</span></span><span class="line"><span class="cl">         <span class="m">1</span>          <span class="m">1</span>    271:   types :<span class="o">=</span> make<span class="o">([]</span>int, size, size<span class="o">)</span>
</span></span><span class="line"><span class="cl">         <span class="m">1</span>          <span class="m">1</span>    272:   last :<span class="o">=</span> make<span class="o">([]</span>int, size, size<span class="o">)</span>
</span></span><span class="line"><span class="cl">         <span class="m">1</span>          <span class="m">1</span>    273:   nodes :<span class="o">=</span> make<span class="o">([]</span>*UnionFindNode, size, size<span class="o">)</span>
</span></span><span class="line"><span class="cl">         .          .    274:
</span></span><span class="line"><span class="cl">         .          .    275:   <span class="k">for</span> i :<span class="o">=</span> 0<span class="p">;</span> i &lt; size<span class="p">;</span> i++ <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="m">360459</span>     <span class="m">360459</span>    276:           nodes<span class="o">[</span>i<span class="o">]</span> <span class="o">=</span> new<span class="o">(</span>UnionFindNode<span class="o">)</span>
</span></span><span class="line"><span class="cl">         .          .    277:   <span class="o">}</span>
</span></span><span class="line"><span class="cl">         .          .    278:
</span></span><span class="line"><span class="cl">         .          .    279:   // Step a:
</span></span><span class="line"><span class="cl">         .          .    280:   //   - initialize all nodes as unvisited.
</span></span><span class="line"><span class="cl">         .          .    281:   //   - depth-first traversal and numbering.
</span></span><span class="line"><span class="cl">         .          .    282:   //   - unreached BB<span class="err">&#39;</span>s are marked as dead.
</span></span><span class="line"><span class="cl">         .          .    283:   //
</span></span><span class="line"><span class="cl">         .          .    284:   <span class="k">for</span> i, bb :<span class="o">=</span> range cfgraph.Blocks <span class="o">{</span>
</span></span><span class="line"><span class="cl">         .          .    285:           number<span class="o">[</span>bb.Name<span class="o">]</span> <span class="o">=</span> unvisited
</span></span><span class="line"><span class="cl">     <span class="m">98308</span>      <span class="m">98308</span>    286:           nonBackPreds<span class="o">[</span>i<span class="o">]</span> <span class="o">=</span> make<span class="o">(</span>map<span class="o">[</span>int<span class="o">]</span>bool<span class="o">)</span>
</span></span><span class="line"><span class="cl">         .          .    287:   <span class="o">}</span>
</span></span><span class="line"><span class="cl">         .          .    288:
</span></span><span class="line"><span class="cl">         .          .    289:   DFS<span class="o">(</span>cfgraph.Start, nodes, number, last, 0<span class="o">)</span>
</span></span><span class="line"><span class="cl">         .          .    290:
</span></span><span class="line"><span class="cl">         .          .    291:   // Step b:
</span></span><span class="line"><span class="cl"><span class="o">(</span>pprof<span class="o">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里依然是解决映射使用带来的影响，主要方式是将映射换成切片，这里使用测试文件列表中的 havlak4，可以看到总耗时又少了一点点。</p>
<p>附：<a href="https://github.com/rsc/benchgraffiti/commit/245d899f7b1a33b0c8148a4cd147cb3de5228c8a"target="_blank" rel="external nofollow noopener noreferrer">diff from havlak3</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ go build havlak4.go
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ./havlak4 --cpuprofile<span class="o">=</span>havlak4.prof
</span></span><span class="line"><span class="cl"><span class="c1"># of loops: 76000 (including 1 artificial root node)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ go tool pprof havlak4.exe havlak4.prof
</span></span><span class="line"><span class="cl">File: havlak4.exe
</span></span><span class="line"><span class="cl">Type: cpu
</span></span><span class="line"><span class="cl">Time: Jul 25, <span class="m">2020</span> at 9:25pm <span class="o">(</span>CST<span class="o">)</span>
</span></span><span class="line"><span class="cl">Duration: 7.35s, Total <span class="nv">samples</span> <span class="o">=</span> 13.03s <span class="o">(</span>177.21%<span class="o">)</span>
</span></span><span class="line"><span class="cl">Entering interactive mode <span class="o">(</span><span class="nb">type</span> <span class="s2">&#34;help&#34;</span> <span class="k">for</span> commands, <span class="s2">&#34;o&#34;</span> <span class="k">for</span> options<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>pprof<span class="o">)</span> top10
</span></span><span class="line"><span class="cl">Showing nodes accounting <span class="k">for</span> 8930ms, 68.53% of 13030ms total
</span></span><span class="line"><span class="cl">Dropped <span class="m">104</span> nodes <span class="o">(</span>cum &lt;<span class="o">=</span> 65.15ms<span class="o">)</span>
</span></span><span class="line"><span class="cl">Showing top <span class="m">10</span> nodes out of <span class="m">84</span>
</span></span><span class="line"><span class="cl">      flat  flat%   sum%        cum   cum%
</span></span><span class="line"><span class="cl">    2660ms 20.41% 20.41%     6190ms 47.51%  runtime.scanobject
</span></span><span class="line"><span class="cl">    1450ms 11.13% 31.54%     5860ms 44.97%  main.FindLoops
</span></span><span class="line"><span class="cl">    1110ms  8.52% 40.06%     1590ms 12.20%  runtime.findObject
</span></span><span class="line"><span class="cl">     900ms  6.91% 46.97%     1580ms 12.13%  runtime.greyobject
</span></span><span class="line"><span class="cl">     810ms  6.22% 53.18%     3300ms 25.33%  runtime.mallocgc
</span></span><span class="line"><span class="cl">     620ms  4.76% 57.94%      820ms  6.29%  main.DFS
</span></span><span class="line"><span class="cl">     390ms  2.99% 60.94%      500ms  3.84%  runtime.heapBitsSetType
</span></span><span class="line"><span class="cl">     380ms  2.92% 63.85%      510ms  3.91%  runtime.spanOf <span class="o">(</span>inline<span class="o">)</span>
</span></span><span class="line"><span class="cl">     310ms  2.38% 66.23%      310ms  2.38%  runtime.arenaIndex <span class="o">(</span>partial-inline<span class="o">)</span>    
</span></span><span class="line"><span class="cl">     300ms  2.30% 68.53%      300ms  2.30%  runtime.memclrNoHeapPointers
</span></span><span class="line"><span class="cl"><span class="o">(</span>pprof<span class="o">)</span> </span></span></code></pre></td></tr></table>
</div>
</div><p>现在，垃圾回收（runtime.mallocgc）占用 53.18%，我们来查看对它的调用</p>
<p><img loading="lazy" src="https://picped-1301226557.cos.ap-beijing.myqcloud.com/pprof005.png" alt="https://picped-1301226557.cos.ap-beijing.myqcloud.com/pprof005.png" srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/pprof005.png?size=small, https://picped-1301226557.cos.ap-beijing.myqcloud.com/pprof005.png?size=medium 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/pprof005.png?size=large 2x" data-title="https://picped-1301226557.cos.ap-beijing.myqcloud.com/pprof005.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>因为时间占比比较小的调用很多，看不出什么，我们可以在 <code>go tool pprof</code> 中添加 <code>--nodefraction=0.1</code> 参数过滤占用低于 10% 的调用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ go tool pprof --nodefraction<span class="o">=</span>0.1 havlak4.exe havlak4.prof
</span></span><span class="line"><span class="cl">File: havlak4.exe
</span></span><span class="line"><span class="cl">Type: cpu
</span></span><span class="line"><span class="cl">Time: Jul 25, <span class="m">2020</span> at 9:25pm <span class="o">(</span>CST<span class="o">)</span>
</span></span><span class="line"><span class="cl">Duration: 7.35s, Total <span class="nv">samples</span> <span class="o">=</span> 13.03s <span class="o">(</span>177.21%<span class="o">)</span>
</span></span><span class="line"><span class="cl">Entering interactive mode <span class="o">(</span><span class="nb">type</span> <span class="s2">&#34;help&#34;</span> <span class="k">for</span> commands, <span class="s2">&#34;o&#34;</span> <span class="k">for</span> options<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>pprof<span class="o">)</span> web mallocgc</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof006.png" alt="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof006.png" srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof006.png?size=small, https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof006.png?size=medium 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof006.png?size=large 2x" data-title="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_pprof006.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>这就非常清楚了，FindLoops 是最主要的占用，然后我们查看它</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>pprof<span class="o">)</span> list FindLoops
</span></span><span class="line"><span class="cl">Total: 13.03s
</span></span><span class="line"><span class="cl"><span class="nv">ROUTINE</span> <span class="o">========================</span> main.FindLoops in F:<span class="se">\G</span>o-web<span class="se">\h</span>avlak4.go
</span></span><span class="line"><span class="cl">     1.45s      5.86s <span class="o">(</span>flat, cum<span class="o">)</span> 44.97% of Total
</span></span><span class="line"><span class="cl">         .          .    270:           <span class="k">return</span>
</span></span><span class="line"><span class="cl">         .          .    271:   <span class="o">}</span>
</span></span><span class="line"><span class="cl">         .          .    272:
</span></span><span class="line"><span class="cl">         .          .    273:   size :<span class="o">=</span> cfgraph.NumNodes<span class="o">()</span>
</span></span><span class="line"><span class="cl">         .          .    274:
</span></span><span class="line"><span class="cl">         .       90ms    275:   nonBackPreds :<span class="o">=</span> make<span class="o">([][]</span>int, size<span class="o">)</span>
</span></span><span class="line"><span class="cl">         .      210ms    276:   backPreds :<span class="o">=</span> make<span class="o">([][]</span>int, size<span class="o">)</span>
</span></span><span class="line"><span class="cl">         .          .    277:
</span></span><span class="line"><span class="cl">         .      250ms    278:   number :<span class="o">=</span> make<span class="o">([]</span>int, size<span class="o">)</span>
</span></span><span class="line"><span class="cl">         .      140ms    279:   header :<span class="o">=</span> make<span class="o">([]</span>int, size, size<span class="o">)</span>
</span></span><span class="line"><span class="cl">         .       80ms    280:   types :<span class="o">=</span> make<span class="o">([]</span>int, size, size<span class="o">)</span>
</span></span><span class="line"><span class="cl">         .       60ms    281:   last :<span class="o">=</span> make<span class="o">([]</span>int, size, size<span class="o">)</span>
</span></span><span class="line"><span class="cl">         .       70ms    282:   nodes :<span class="o">=</span> make<span class="o">([]</span>*UnionFindNode, size, size<span class="o">)</span>        
</span></span><span class="line"><span class="cl">         .          .    283:
</span></span><span class="line"><span class="cl">         .          .    284:   <span class="k">for</span> i :<span class="o">=</span> 0<span class="p">;</span> i &lt; size<span class="p">;</span> i++ <span class="o">{</span>
</span></span><span class="line"><span class="cl">      10ms      590ms    285:           nodes<span class="o">[</span>i<span class="o">]</span> <span class="o">=</span> new<span class="o">(</span>UnionFindNode<span class="o">)</span>
</span></span><span class="line"><span class="cl">         .          .    286:   <span class="o">}</span>
</span></span><span class="line"><span class="cl">         .          .    287:
</span></span><span class="line"><span class="cl">...</span></span></code></pre></td></tr></table>
</div>
</div><p>每次 FindLoops 被调用，都会进行一系列的初始化工作，为了处理这些内存分配，垃圾回收器的占用才会那么高。所以我们要意识到，语言自带垃圾回收不意味着不需要再关心内存分配问题，这里解决该问题的方法是使用缓存，以便每次不需要重新分配和回收内存。</p>
<p>添加一个全局的结构 cache</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">cache</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">size</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nonBackPreds</span> <span class="p">[][]</span><span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">backPreds</span> <span class="p">[][]</span><span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">number</span> <span class="p">[]</span><span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">header</span> <span class="p">[]</span><span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">types</span> <span class="p">[]</span><span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">last</span> <span class="p">[]</span><span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nodes</span> <span class="p">[]</span><span class="o">*</span><span class="nx">UnionFindNode</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>然后在 FindLoops 中每次访问它而不是重新分配（这种方式并不是一种很好的方式，但是确实能在此程序中提升时间）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">size</span> <span class="p">&lt;</span> <span class="nx">size</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cache</span><span class="p">.</span><span class="nx">size</span> <span class="p">=</span> <span class="nx">size</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cache</span><span class="p">.</span><span class="nx">nonBackPreds</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([][]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cache</span><span class="p">.</span><span class="nx">backPreds</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([][]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cache</span><span class="p">.</span><span class="nx">number</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cache</span><span class="p">.</span><span class="nx">header</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cache</span><span class="p">.</span><span class="nx">types</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cache</span><span class="p">.</span><span class="nx">last</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cache</span><span class="p">.</span><span class="nx">nodes</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">UnionFindNode</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">nodes</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">cache</span><span class="p">.</span><span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">UnionFindNode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">nonBackPreds</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">nonBackPreds</span><span class="p">[:</span><span class="nx">size</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">nonBackPreds</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nonBackPreds</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">nonBackPreds</span><span class="p">[</span><span class="nx">i</span><span class="p">][:</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">backPreds</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">backPreds</span><span class="p">[:</span><span class="nx">size</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">nonBackPreds</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">backPreds</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">backPreds</span><span class="p">[</span><span class="nx">i</span><span class="p">][:</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">number</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">number</span><span class="p">[:</span><span class="nx">size</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">header</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">header</span><span class="p">[:</span><span class="nx">size</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">types</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">types</span><span class="p">[:</span><span class="nx">size</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">last</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">last</span><span class="p">[:</span><span class="nx">size</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">nodes</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">nodes</span><span class="p">[:</span><span class="nx">size</span><span class="p">]</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这一更改实现在了 havlak5 中，我们从测试文件列表中找到该文件并使用，发现时间占用已经减少到了 10s 以下</p>
<p>附：<a href="https://github.com/rsc/benchgraffiti/commit/2d41d6d16286b8146a3f697dd4074deac60d12a4"target="_blank" rel="external nofollow noopener noreferrer">diff from havlak4</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ go build havlak5.go
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ./havlak5.exe --cpuprofile<span class="o">=</span>havlak5.prof
</span></span><span class="line"><span class="cl"><span class="c1"># of loops: 76000 (including 1 artificial root node)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ go tool pprof havlak5.exe havlak5.prof
</span></span><span class="line"><span class="cl">File: havlak5.exe
</span></span><span class="line"><span class="cl">Type: cpu
</span></span><span class="line"><span class="cl">Time: Jul 25, <span class="m">2020</span> at 9:46pm <span class="o">(</span>CST<span class="o">)</span>
</span></span><span class="line"><span class="cl">Duration: 4.89s, Total <span class="nv">samples</span> <span class="o">=</span> 7.34s <span class="o">(</span>150.01%<span class="o">)</span>
</span></span><span class="line"><span class="cl">Entering interactive mode <span class="o">(</span><span class="nb">type</span> <span class="s2">&#34;help&#34;</span> <span class="k">for</span> commands, <span class="s2">&#34;o&#34;</span> <span class="k">for</span> options<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>pprof<span class="o">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>还有很多的工作可以进行从而使程序更快，但都不需要 pprof 的协助，最终的版本 havlak6 可以减少到 2.29s 和 351M存储占用。</p>
<p>当然，最简单的方式是使用 go test 工具，Go 提供的测试机制可以很容易的提供 CPU 和存储的占用分析。</p>
<h2 id="3-分析网络程序" class="heading-element"><span>3. 分析网络程序</span>
  <a href="#3-%e5%88%86%e6%9e%90%e7%bd%91%e7%bb%9c%e7%a8%8b%e5%ba%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>就像我们一开始说的，分析一个网络程序更加的简单，只需要导入 <code>net/http/pprof</code> 包即可，不需要在程序中使用，只需要添加这一条导入语句。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nx">_</span> <span class="s">&#34;net/http/pprof&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>导入该包会添加一些 /debug/pprof/ URL 下面的一些处理器函数，之后简单的运行 go tool pprof 然后添加服务器 URL就会实时的检查配置文件。</p>
<p>以我们之前写的一个文件上传下载应用为例，端口使用 8090，添加导入语句后，打开浏览器 http://localhost:8090/debug/pprof/，显示如下</p>
<p><img loading="lazy" src="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_Snipaste_2020-07-25_22-01-39.png" alt="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_Snipaste_2020-07-25_22-01-39.png" srcset="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_Snipaste_2020-07-25_22-01-39.png?size=small, https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_Snipaste_2020-07-25_22-01-39.png?size=medium 1.5x, https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_Snipaste_2020-07-25_22-01-39.png?size=large 2x" data-title="https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20200727_Snipaste_2020-07-25_22-01-39.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>或者在命令行使用 <code>go tool pprof</code> 命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">go tool pprof http://localhost:8090/debug/pprof/profile   <span class="c1"># 30-second CPU profile</span>
</span></span><span class="line"><span class="cl">go tool pprof http://localhost:8090/debug/pprof/heap      <span class="c1"># heap profile</span>
</span></span><span class="line"><span class="cl">go tool pprof http://localhost:8090/debug/pprof/block     <span class="c1"># goroutine blocking profile</span></span></span></code></pre></td></tr></table>
</div>
</div><p>进入 pprof 命令行界面后就和前面的使用没有区别了，这几个文件简单介绍如下</p>
<ul>
<li><code>/debug/pprof/profile</code>：访问这个链接会自动进行 CPU profiling，持续 30s，并生成一个文件供下载</li>
<li><code>/debug/pprof/heap</code>： Memory Profiling 的路径，访问这个链接会得到一个内存 Profiling 结果的文件</li>
<li><code>/debug/pprof/block</code>：block Profiling 的路径</li>
</ul>
<p>最后，上面的导入形式是基于我们使用默认的 http.DefaultServeMux 的情况，如果使用了其它的包，比如 Mux，需要手动添加路由规则</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">r</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/debug/pprof/&#34;</span><span class="p">,</span> <span class="nx">pprof</span><span class="p">.</span><span class="nx">Index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">r</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/debug/pprof/cmdline&#34;</span><span class="p">,</span> <span class="nx">pprof</span><span class="p">.</span><span class="nx">Cmdline</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">r</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/debug/pprof/profile&#34;</span><span class="p">,</span> <span class="nx">pprof</span><span class="p">.</span><span class="nx">Profile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">r</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/debug/pprof/symbol&#34;</span><span class="p">,</span> <span class="nx">pprof</span><span class="p">.</span><span class="nx">Symbol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">r</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/debug/pprof/trace&#34;</span><span class="p">,</span> <span class="nx">pprof</span><span class="p">.</span><span class="nx">Trace</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>之后的使用就没有区别了。</p></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2020-07-27 00:00:00">Updated on 2020-07-27&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"><span><a href="/2020/golang-deep-learning-6-performance-analysis-pprof/index.md" title="Read Markdown" class="link-to-markdown">Read Markdown</a></span></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Share on Pocket" data-sharer="pocket" data-url="http://localhost:1313/2020/golang-deep-learning-6-performance-analysis-pprof/"><i class="fa-brands fa-get-pocket fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://localhost:1313/2020/golang-deep-learning-6-performance-analysis-pprof/" data-title="Golang深入学习6-使用pprof进行性能分析"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/golang/" class="post-tag" title="Tags - Golang">Golang</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div><div class="post-nav"><a href="/2020/golang-deep-learning-5-debug-with-dlv/" class="post-nav-item" rel="prev" title="Golang深入学习5-使用dlv调试程序"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Golang深入学习5-使用dlv调试程序</a><a href="/2020/golang-deep-learning-7-scheduler-and-garbage-collection/" class="post-nav-item" rel="next" title="Golang深入学习7-调度器与垃圾回收">Golang深入学习7-调度器与垃圾回收<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div class="post-reward">
    <div class="comment"></div>
    <input type="checkbox" class="reward-input" name="reward" id="fi-reward" hidden />
    <label class="reward-button" for="fi-reward"><i class="fa-solid fa-qrcode fa-fw" aria-hidden="true"></i>Donate</label>
    <div class="reward-ways" data-mode="static"><div><img loading="lazy" src="https://picped-1301226557.cos.ap-beijing.myqcloud.com/alipay.png" alt="Alipay" data-title="Alipay" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span>Alipay</span>
          </div><div><img loading="lazy" src="https://picped-1301226557.cos.ap-beijing.myqcloud.com/wechatpay.png" alt="WeChat Pay" data-title="WeChat Pay" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span>WeChat Pay</span>
          </div></div>
  </div></article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.135.0"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.13"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2018 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><a href="https://github.com/songdehuacool/songdehuacool.github.io" title="View source on GitHub"target="_blank" rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true" width="56" height="56"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/twemoji/twemoji.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/pangu/pangu.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{"enable":false},"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"pangu":{"enable":true,"selector":"article"},"search":{"distance":100,"findAllMatches":false,"highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"No results found","snippetLength":30,"threshold":0.3,"useExtendedSearch":false},"twemoji":true,"version":"v0.3.13"};console.log('Page config:', window.config);</script><script src="/js/theme.min.js" defer></script></body>
</html>
